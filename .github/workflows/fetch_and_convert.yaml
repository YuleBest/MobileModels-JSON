name: Sync to D1 via Python API

on:
  schedule:
    # æ—¢ç„¶æœ‰äº† MD5 æ‹¦æˆªï¼Œä½ å¯ä»¥æŠŠé¢‘ç‡è°ƒé«˜ä¸€ç‚¹ï¼ˆæ¯”å¦‚ç°åœ¨æ˜¯æ¯3å°æ—¶çš„37åˆ†è·‘ä¸€æ¬¡ï¼‰
    - cron: "37 */3 * * *"
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»æœ‰å†™å…¥æƒé™ï¼Œå¦åˆ™ push ä¼šæŠ¥é”™

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install pandas requests

      - name: Run Sync Script
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_DATABASE_ID: ${{ secrets.CLOUDFLARE_DATABASE_ID }}
        # ç¡®ä¿ä½ çš„ Python è„šæœ¬æ–‡ä»¶åæ˜¯ converter.py
        run: python converter.py

      - name: Commit and Push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # å…³é”®ï¼šæŠŠ MD5 è®°å½•æ–‡ä»¶ä¹ŸåŠ è¿›å»ï¼Œä½œä¸ºä¸‹æ¬¡è¿è¡Œçš„â€œæ¯”å¯¹åŸºå‡†â€
          git add update.sql update_time.txt last_csv_md5.txt

          # å¦‚æœæ²¡æœ‰æ–‡ä»¶å˜åŠ¨ï¼ˆMD5ä¸€è‡´ï¼‰ï¼Œcommit ä¼šè·³è¿‡
          if git diff --staged --quiet; then
            echo "ğŸ“‹ No changes detected, skipping git push."
          else
            git commit -m "Auto update SQL, timestamp and MD5 check"
            git push
          fi
